name: Sonar Quality Gate
on: [push]
jobs:
    build:
      name: Build
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v2
          with:
            fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
        - name: Install dependencies
          run: yarn
        - name: Test and coverage
          run: yarn test --coverage --watchAll=false
        - uses: sonarsource/sonarqube-scan-action@master
          with:
            args: >
                -Dsonar.javascript.lcov.reportPaths=./coverage/lcov.info
                -Dsonar.test.inclusions=**/*.test.js,**/*.spec.js
          env:
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
            SONAR_ROOT_CERT: ${{ secrets.SONAR_ROOT_CERT }}
        - uses: sonarsource/sonarqube-quality-gate-action@master
          timeout-minutes: 5
          env:
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            SONAR_ROOT_CERT: ${{ secrets.SONAR_ROOT_CERT }}